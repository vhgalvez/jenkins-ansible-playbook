# playbooks/01_generate-admin-secret.yml
# ---------------------------------------------------------------------------
# Genera y sella el Secret Â«jenkins-adminÂ» (contraseÃ±a en textoÂ plano)
# ---------------------------------------------------------------------------
- name: ğŸ” Generar y sellar el Secret Â«jenkins-adminÂ»
  hosts: localhost
  gather_facts: false

  vars_files:
    - ../vars/main.yml            # kubeconfig_path, kubeseal_path, etc.

  vars:
    work_dir:            "{{ playbook_dir }}/files"
    tpl_secret:          "../templates/secret/jenkins-admin-secret.yaml.j2"
    tmp_plain:           "{{ work_dir }}/jenkins-admin-unsealed.yaml"
    tmp_sealed:          "{{ work_dir }}/jenkins-admin-sealed.yaml"

    jenkins_admin_secret_name: jenkins-admin
    jenkins_admin_user_key:    jenkins-admin-user
    jenkins_admin_pass_key:    jenkins-admin-password

  tasks:
  - name: ğŸ“¥ Leer .env (base64)
    slurp:
      src: "{{ playbook_dir }}/../.env"
    register: env_file

  - name: ğŸ“Œ Extraer credenciales UI
    set_fact:
      env_lines:                 "{{ env_file.content | b64decode | split('\n') }}"
      jenkins_auth_user_ui: >-
        {{ env_lines | select('match','^JENKINS_AUTH_USER_UI=') | first | regex_replace('^JENKINS_AUTH_USER_UI=', '') | default('') }}
      jenkins_auth_pass_ui: >-
        {{ env_lines | select('match','^JENKINS_AUTH_PASS_UI=') | first | regex_replace('^JENKINS_AUTH_PASS_UI=', '') | default('') }}

  - name: âŒ Validar usuario y contraseÃ±a
    assert:
      that:
        - jenkins_auth_user_ui | length > 0
        - jenkins_auth_pass_ui | length > 0
      fail_msg: "âŒ Faltan JENKINS_AUTH_USER_UI o JENKINS_AUTH_PASS_UI en .env"

  #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Render â†’ Sellar â†’ Aplicar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: ğŸ“‚ Crear workdir
    file: { path: "{{ work_dir }}", state: directory, mode: 0755 }

  - name: ğŸ“ Renderizar Secret (sin sellar)
    template:
      src:  "{{ tpl_secret }}"
      dest: "{{ tmp_plain }}"

  - name: ğŸ” Sellar el Secret
    shell: |
      {{ kubeseal_path }} \
        --controller-name sealed-secrets-controller \
        --controller-namespace kube-system \
        --format yaml < "{{ tmp_plain }}" > "{{ tmp_sealed }}"
    environment: { KUBECONFIG: "{{ kubeconfig_path }}" }

  - file: { path: "{{ tmp_plain }}", state: absent }   # limpiar

  - name: ğŸš€ Aplicar SealedSecret
    command: >
      {{ kubectl_path }} --kubeconfig {{ kubeconfig_path }}
      apply -f {{ tmp_sealed }}
    register: apply_res
    changed_when: "'created' in apply_res.stdout or 'configured' in apply_res.stdout"

  - debug: { msg: "{{ apply_res.stdout | default(apply_res.stderr) }}" }