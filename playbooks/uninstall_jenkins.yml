# playbooks/uninstall_jenkins.yml
# ğŸ§¹ Desinstalar Jenkins y sus recursos asociados de Kubernetes (Helm + objetos personalizados)
---
- name: ğŸ§¹ Desinstalar Jenkins y limpiar recursos asociados
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../vars/main.yml

  environment:
    PATH: "/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin"
    KUBECONFIG: "/home/victory/.kube/config"

  tasks:
    #####################################################################
    # 1. Validar herramientas disponibles
    #####################################################################
    - name: ğŸ” Verificar que helm estÃ¡ disponible
      command: which helm
      register: helm_check
      failed_when: helm_check.rc != 0
      changed_when: false

    - name: ğŸ” Verificar que kubectl estÃ¡ disponible
      command: which kubectl
      register: kubectl_check
      failed_when: kubectl_check.rc != 0
      changed_when: false

    #####################################################################
    # 2. Desinstalar Jenkins desde Helm
    #####################################################################
    - name: ğŸ§¼ Desinstalar release '{{ jenkins_release_name }}' en namespace '{{ helm_namespace }}'
      shell: |
        helm list -n {{ helm_namespace }} | grep -q "^{{ jenkins_release_name }}\b" \
        && helm uninstall {{ jenkins_release_name }} -n {{ helm_namespace }} \
        || echo "Release no existe"
      register: helm_uninstall
      changed_when: "'uninstall' in helm_uninstall.stdout"
      failed_when: false

    - name: ğŸ“¤ Resultado de desinstalaciÃ³n con Helm
      debug:
        msg: "{{ helm_uninstall.stdout | default(helm_uninstall.stderr) }}"

    #####################################################################
    # 3. Eliminar recursos Kubernetes personalizados
    #####################################################################
    - name: ğŸ—‘ï¸ Eliminar PVCs, SealedSecrets, IngressRoute, Middleware, Secret TLS
      shell: |
        kubectl delete pvc -l app.kubernetes.io/instance={{ jenkins_release_name }} -n {{ helm_namespace }} || true
        kubectl delete sealedsecret -l app.kubernetes.io/instance={{ jenkins_release_name }} -n {{ helm_namespace }} || true
        kubectl delete ingressroute -l app.kubernetes.io/instance={{ jenkins_release_name }} -n {{ helm_namespace }} || true
        kubectl delete middleware {{ jenkins_middleware_name }} -n {{ helm_namespace }} || true
        kubectl delete secret {{ tls_secret_name }} -n {{ helm_namespace }} || true
      register: extra_resources
      changed_when: "'deleted' in extra_resources.stdout"
      failed_when: false

    - name: ğŸ“¤ Resultado de eliminaciÃ³n de recursos personalizados
      debug:
        msg: "{{ extra_resources.stdout }}"

    #####################################################################
    # 4. Eliminar namespace si quedÃ³ vacÃ­o
    #####################################################################
    - name: ğŸ§¨ Eliminar namespace '{{ helm_namespace }}' si quedÃ³ vacÃ­o
      shell: |
        kubectl get ns {{ helm_namespace }} &>/dev/null \
        && kubectl delete ns {{ helm_namespace }} || echo "Namespace no existe"
      register: ns_delete
      changed_when: "'deleted' in ns_delete.stdout"
      failed_when: false

    - name: ğŸ“¤ Resultado de eliminaciÃ³n del namespace
      debug:
        msg: "{{ ns_delete.stdout }}"

    #####################################################################
    # 5. ConfirmaciÃ³n final
    #####################################################################
    - name: âœ… Verificar si el namespace fue eliminado
      shell: kubectl get ns {{ helm_namespace }} 2>/dev/null || echo ""
      register: ns_check
      changed_when: false

    - name: ğŸ‰ ConfirmaciÃ³n de eliminaciÃ³n completa
      debug:
        msg: "âœ… Jenkins y el namespace '{{ helm_namespace }}' fueron eliminados completamente."
      when: ns_check.stdout == ""

    - name: âš ï¸ Advertencia si el namespace aÃºn existe
      debug:
        msg: "âš ï¸ El namespace '{{ helm_namespace }}' aÃºn existe. Verifica recursos colgantes o permisos."
      when: ns_check.stdout != ""
