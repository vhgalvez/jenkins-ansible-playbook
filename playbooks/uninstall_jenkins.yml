# playbooks/uninstall_jenkins.yml
---
# ğŸ§¹ Desinstalar Jenkins de Kubernetes usando Ansible

- name: Desinstalar Jenkins de Kubernetes
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../group_vars/all.yml
  environment:
    PATH: "/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin"
    KUBECONFIG: "/home/victory/.kube/config"

  tasks:
    - name: ğŸš€ Iniciando desinstalaciÃ³n de Jenkins...
      debug:
        msg: "Desinstalando la release '{{ jenkins_release_name }}' del namespace '{{ helm_namespace }}'."

    # Eliminar Jenkins usando Helm, sin eliminar Helm ni otros recursos globales
    - name: ğŸ§¹ Eliminar release de Jenkins
      shell: helm uninstall {{ jenkins_release_name }} -n {{ helm_namespace }}
      register: helm_uninstall
      changed_when: "'uninstalled' in helm_uninstall.stdout"
      failed_when: helm_uninstall.rc != 0 and "'not found' not in helm_uninstall.stderr"

    - name: ğŸ“„ Mostrar resultado de Helm uninstall
      debug:
        msg: "{{ helm_uninstall.stdout | default(helm_uninstall.stderr) }}"

    # Eliminar recursos especÃ­ficos de Jenkins del namespace, pero no el namespace
    - name: ğŸ§¹ Eliminar recursos especÃ­ficos de Jenkins en el namespace
      shell: |
        kubectl delete deployment,svc,pod,secret,configmap -l app=jenkins -n {{ helm_namespace }}
      register: jenkins_resources_delete
      changed_when: "'deleted' in jenkins_resources_delete.stdout"
      failed_when: false

    - name: ğŸ“„ Mostrar resultado de eliminaciÃ³n de recursos especÃ­ficos de Jenkins
      debug:
        msg: "{{ jenkins_resources_delete.stdout }}"

    # Eliminar el namespace de Jenkins si ya no se requiere (opcional)
    - name: ğŸ—‘ Eliminar namespace de Jenkins (si ya no es necesario)
      shell: |
        kubectl get ns {{ helm_namespace }} &>/dev/null && \
        kubectl delete ns {{ helm_namespace }} || echo "Namespace no existe"
      register: ns_delete
      changed_when: "'deleted' in ns_delete.stdout"
      failed_when: false

    - name: ğŸ“„ Mostrar resultado de eliminaciÃ³n del namespace
      debug:
        msg: "{{ ns_delete.stdout }}"

    - name: âœ… Verificar si el namespace fue eliminado
      shell: kubectl get ns {{ helm_namespace }} 2>/dev/null || echo ""
      register: ns_check
      changed_when: false

    - name: ğŸ‰ ConfirmaciÃ³n de eliminaciÃ³n total
      debug:
        msg: "âœ… Jenkins y los recursos especÃ­ficos del namespace '{{ helm_namespace }}' fueron eliminados completamente."
      when: ns_check.stdout == ""

    - name: âš ï¸ Namespace aÃºn existe
      debug:
        msg: "âš ï¸ El namespace '{{ helm_namespace }}' aÃºn existe. Revisa recursos colgantes o permisos."
      when: ns_check.stdout != ""