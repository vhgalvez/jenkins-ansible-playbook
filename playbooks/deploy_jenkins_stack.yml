# playbooks\deploy_jenkins_stack.yml
---
- name: ğŸ“¦ 0 Copiar Secret TLS (wildcard-socialdevs-tls)
  import_playbook: 00_copy_tls_secret.yml

- name: ğŸ” Generar y aplicar SealedSecret de autenticaciÃ³n para Jenkins
  import_playbook: 01_generate-auth-secret.yml

- name: ğŸ§© Renderizar y aplicar Middleware + IngressRoute para Jenkins
  import_playbook: 02_render_and_apply_jenkins_ingress.yml

- name: ğŸ“¦ Instalar Jenkins con Helm
  import_playbook: 03_install_jenkins.yml

###########################################################################
# âœ… VerificaciÃ³n final: Credenciales, estado del Pod y acceso HTTPS
###########################################################################
- hosts: localhost
  gather_facts: false
  vars_files:
    - ../vars/main.yml

  tasks:
    #####################################################################
    # 1. Validar que las credenciales estÃ©n presentes
    #####################################################################
    - name: âœ… Validar credenciales de autenticaciÃ³n para Jenkins
      assert:
        that:
          - jenkins_auth_user is defined
          - jenkins_auth_pass is defined
        msg: "âŒ Credenciales de autenticaciÃ³n no definidas."

    #####################################################################
    # 2. Esperar a que el Pod de Jenkins estÃ© listo (condiciÃ³n Ready)
    #####################################################################
    - name: â³ Esperar a que el Pod de Jenkins estÃ© listo
      shell: >
        kubectl -n jenkins wait pod
        -l app.kubernetes.io/component=jenkins-controller
        --for=condition=Ready
        --timeout=300s
      changed_when: false

    #####################################################################
    # 3. Verificar acceso al Dashboard de Jenkins (HTTPS + BasicAuth)
    #####################################################################
    - name: ğŸŒ Verificar acceso al Dashboard de Jenkins por HTTPS
      shell: >
        curl --http1.1 -k
        -u {{ jenkins_auth_user }}:{{ jenkins_auth_pass }}
        https://{{ jenkins_dashboard_domain }}/
        --max-time 20
        --silent
        --output /dev/null
        --write-out '%{http_code}'
      register: dashboard_status
      retries: 25
      delay: 8
      until: dashboard_status.stdout in ['200', '302', '307', '401', '403']
      changed_when: false
      failed_when: dashboard_status.stdout not in ['200', '302', '307', '401', '403']