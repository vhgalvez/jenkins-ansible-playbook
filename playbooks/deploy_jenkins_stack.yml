# playbooks/deploy_jenkins_stack.yml
---
# Fase 0–2: Preparativos
- import_playbook: 00_copy_tls_secret.yml
- import_playbook: 01_generate-auth-secret.yml
- import_playbook: 02_render_and_apply_jenkins_ingress.yml

# Fase 3: Crear Secrets antes del Helm install
- import_playbook: 03_create_secrets.yml

# Fase 4: Instalar Jenkins (Secrets ya presentes)
- import_playbook: 04_install_jenkins.yml

###########################################################################
# ✅ Verificación final: Carga de credenciales + Validación del estado
###########################################################################

- hosts: localhost
  gather_facts: false

  tasks:
    - name: 📥 Cargar .env como variables
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../.env"
        dotenv: true

# Segunda parte: Validaciones usando esas variables y vars/main.yml
- hosts: localhost
  gather_facts: false
  vars_files:
    - ../vars/main.yml

  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
    PATH: "/usr/local/bin:/usr/bin:/bin"

  tasks:
    #####################################################################
    # 1. Validar que las credenciales estén presentes
    #####################################################################
    - name: ✅ Validar credenciales de autenticación para Jenkins
      assert:
        that:
          - jenkins_auth_user is defined
          - jenkins_auth_pass is defined
        msg: "❌ Credenciales de autenticación no definidas (jinja_vars)."

    #####################################################################
    # 2. Esperar a que el Pod de Jenkins esté listo
    #####################################################################
    - name: ⏳ Esperar a que el Pod de Jenkins esté listo
      ansible.builtin.shell: >
        {{ kubectl_path }} -n {{ helm_namespace }}
        wait pod -l app.kubernetes.io/component=jenkins-controller
        --for=condition=Ready
        --timeout=300s
      changed_when: false
      register: wait_result
      failed_when: wait_result.rc != 0

    #####################################################################
    # 3. Verificar acceso al Dashboard de Jenkins (HTTPS + BasicAuth)
    #####################################################################
    - name: 🌐 Verificar acceso al Dashboard de Jenkins por HTTPS
      ansible.builtin.shell: >
        curl --http1.1 -k
        -u {{ jenkins_auth_user }}:{{ jenkins_auth_pass }}
        https://{{ jenkins_dashboard_domain }}/
        --max-time 20
        --silent --output /dev/null --write-out '%{http_code}'
      register: dashboard_status
      retries: 25
      delay: 8
      until: dashboard_status.stdout in ['200','302','307','401','403']
      changed_when: false
      failed_when: dashboard_status.stdout not in ['200','302','307','401','403']

    - name: 📊 Mostrar código HTTP devuelto
      debug:
        msg: "Código HTTP recibido del dashboard: {{ dashboard_status.stdout }}"
