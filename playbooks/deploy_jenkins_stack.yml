# playbooks\deploy_jenkins_stack.yml
---
- name: ğŸ” Generar y aplicar SealedSecret de autenticaciÃ³n para Jenkins
  import_playbook: 01_generate-auth-secret.yml

- name: ğŸ§© Renderizar y aplicar Middleware + IngressRoute para Jenkins
  import_playbook: 02_render_and_apply_jenkins_ingress.yml

- name: ğŸ“¦ Instalar Jenkins con Helm
  import_playbook: 03_install_jenkins.yml

# VerificaciÃ³n de variables y acceso al dashboard de Jenkins
- hosts: localhost
  gather_facts: false
  vars_files:
    - ../vars/main.yml

  tasks:
    # Validar que las credenciales de Jenkins estÃ©n definidas
    - name: âœ… Validar credenciales de autenticaciÃ³n para Jenkins
      assert:
        that:
          - jenkins_auth_user is defined
          - jenkins_auth_pass is defined
        msg: "âŒ Credenciales de autenticaciÃ³n no definidas."

    # Comprobar acceso al Dashboard de Jenkins
    - name: ğŸŒ Comprobar acceso al Dashboard de Jenkins
      shell: >
        curl --http1.1 -k -u {{ jenkins_auth_user }}:{{ jenkins_auth_pass }}
        https://{{ jenkins_dashboard_domain }}/
        --max-time 10 --silent --output /dev/null --write-out '%{http_code}'
      register: dashboard_status
      retries: 3  # NÃºmero de reintentos
      delay: 5  # Retardo entre los intentos (en segundos)
      changed_when: false
      failed_when: dashboard_status.stdout not in ['200','302','307','401']

    # Mostrar resultado HTTP
    - name: ğŸ› ï¸ Mostrar resultado HTTP
      debug:
        msg: "CÃ³digo HTTP recibido: {{ dashboard_status.stdout }}"

    # Fallar si no se puede acceder al Dashboard de Jenkins despuÃ©s de los reintentos
    - name: âŒ Fallar si no se puede acceder al Dashboard de Jenkins
      fail:
        msg: "El acceso al Dashboard de Jenkins fallÃ³ despuÃ©s de 3 intentos. CÃ³digo HTTP: {{ dashboard_status.stdout }}"
      when: dashboard_status.stdout not in ['200','302','307','401']