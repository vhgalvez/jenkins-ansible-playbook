---
# playbooks/03_create_secrets.yml
# ğŸ” Secretos necesarios para Jenkins + Kaniko en PRODUCCIÃ“N
- hosts: localhost
  gather_facts: false
  vars_files:
    - ../vars/main.yml
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
    PATH: "/usr/local/bin:/usr/bin:/bin"

  tasks:
    # 0. Cargar .env (si existe)
    - name: ğŸ“¥ Cargar .env manualmente
      shell: |
        set -a && source "{{ playbook_dir }}/../.env" && set +a
      register: dotenv_result
      changed_when: false
      failed_when: false

    # 0.1 Validar variables crÃ­ticas
    - name: âœ… Validar variables crÃ­ticas
      assert:
        that:
          - dockerhub_username is defined
          - dockerhub_token is defined
          - github_token is defined
        fail_msg: "âŒ Faltan variables crÃ­ticas para los Secrets."
        success_msg: "âœ… Variables crÃ­ticas presentes."

    # 1. dockerhub-credentials
    - name: ğŸ” Crear secreto dockerhub-credentials
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: dockerhub-credentials
            namespace: "{{ jenkins_namespace }}"
          type: kubernetes.io/basic-auth
          stringData:
            username: "{{ dockerhub_username }}"
            password: "{{ dockerhub_token }}"

    # 2. github-ci-token
    - name: ğŸ” Crear secreto github-ci-token
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: github-ci-token
            namespace: "{{ jenkins_namespace }}"
          type: Opaque
          stringData:
            token: "{{ github_token }}"

    # 3. dockerhub-config
    - name: ğŸ” Crear secreto dockerhub-config (Kaniko)
      vars:
        docker_auth_b64: "{{ (dockerhub_username + ':' + dockerhub_token) | b64encode }}"
        docker_cfg_json: |
          {
            "auths": {
              "https://index.docker.io/v1/": {
                "auth": "{{ docker_auth_b64 }}"
              }
            }
          }
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: dockerhub-config
            namespace: "{{ jenkins_namespace }}"
          type: Opaque
          stringData:
            config.json: "{{ docker_cfg_json }}"