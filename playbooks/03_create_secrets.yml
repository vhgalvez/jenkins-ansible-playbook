---
# playbooks/03_create_secrets.yml
# ðŸ” Secretos necesarios para Jenkins + Kaniko en PRODUCCIÃ“N
- hosts: localhost
  gather_facts: false
  vars_files:
    - ../vars/main.yml            # ruta a dockerhub_username / dockerhub_token / github_token â€¦
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
    PATH: "/usr/local/bin:/usr/bin:/bin"

  tasks:
  ####################################################################
  # 0.  Cargar .env (si existe) para inyectar variables al runtime
  ####################################################################
  - name: ðŸ“¥Â Cargar .env manualmente (si existe)
    shell: |
      if [ -f "{{ playbook_dir }}/../.env" ]; then
        set -a && . "{{ playbook_dir }}/../.env" && set +a
      fi
    changed_when: false
    failed_when: false

  ####################################################################
  # 0.1 ValidaciÃ³n de variables imprescindibles
  ####################################################################
  - name: âœ…Â Validar variables crÃ­ticas
    assert:
      that:
        - dockerhub_username is defined
        - dockerhub_token     is defined
        - github_token        is defined
      fail_msg:  "âŒÂ Faltan variables crÃ­ticas para los Secrets."
      success_msg: "âœ…Â Variables crÃ­ticas presentes."

  ####################################################################
  # 1. dockerhubâ€‘credentials  (â†’ se monta vÃ­a envFrom)
  ####################################################################
  - name: ðŸ”Â Crear/ActualizarÂ dockerhubâ€‘credentials
    kubernetes.core.k8s:
      state: present
      definition:
        apiVersion: v1
        kind: Secret
        metadata:
          name: dockerhub-credentials
          namespace: "{{ jenkins_namespace }}"
        type: kubernetes.io/basic-auth       # username / password
        stringData:
          DOCKERHUB_USERNAME: "{{ dockerhub_username }}"
          DOCKERHUB_TOKEN:    "{{ dockerhub_token }}"

  ####################################################################
  # 2. githubâ€‘ciâ€‘token  (â†’ se monta vÃ­a envFrom)
  ####################################################################
  - name: ðŸ”Â Crear/ActualizarÂ githubâ€‘ciâ€‘token
    kubernetes.core.k8s:
      state: present
      definition:
        apiVersion: v1
        kind: Secret
        metadata:
          name: github-ci-token
          namespace: "{{ jenkins_namespace }}"
        type: Opaque
        stringData:
          GITHUB_TOKEN: "{{ github_token }}"

  ####################################################################
  # 3. dockerhubâ€‘config  (â†’ Kaniko leerÃ¡ /kaniko/.docker/config.json)
  ####################################################################
  - name: ðŸ”Â Crear/ActualizarÂ dockerhubâ€‘config (Kaniko)
    vars:
      docker_auth_b64: "{{ (dockerhub_username ~ ':' ~ dockerhub_token) | b64encode }}"
      # Construimos JSON como **string plano** (â€¼ï¸  requisito de Kubernetes)
      docker_cfg_json: >-
        {
          "auths": {
            "https://index.docker.io/v1/": {
              "auth": "{{ docker_auth_b64 }}"
            }
          }
        }
    kubernetes.core.k8s:
      state: present
      definition:
        apiVersion: v1
        kind: Secret
        metadata:
          name: dockerhub-config
          namespace: "{{ jenkins_namespace }}"
        type: Opaque
        stringData:
          config.json: "{{ docker_cfg_json }}"