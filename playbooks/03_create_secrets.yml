---
# playbooks/03_create_secrets.yml
# ğŸ” Secretos necesarios para Jenkins + Kaniko en PRODUCCIÃ“N
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- hosts: localhost
  gather_facts: false
  vars_files:
    - ../vars/main.yml  # â† dockerhub_username, dockerhub_token, github_token, jenkins_namespace
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
    PATH: "/usr/local/bin:/usr/bin:/bin"

  tasks:

    # â–¸ 0. Cargar .env si se desea usar desde archivo externo
    - name: ğŸ“¥ Cargar .env manualmente (opcional, si no defines en vars.yml)
      shell: |
        set -a
        source "{{ playbook_dir }}/../.env"
        set +a
      register: dotenv_result
      changed_when: false
      failed_when: false  # â† toleramos si no existe

    # â–¸ 0.1 Validar variables crÃ­ticas
    - name: âœ… Validar que las variables estÃ©n definidas
      assert:
        that:
          - dockerhub_username is defined
          - dockerhub_token is defined
          - github_token is defined
        fail_msg: "âŒ Faltan variables crÃ­ticas para crear secretos de Jenkins/Kaniko."
        success_msg: "âœ… Variables necesarias presentes."

    # â–¸ 1. dockerhub-credentials (para plugins en Jenkins)
    - name: ğŸ” Crear secreto dockerhub-credentials (Jenkins plugins)
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: dockerhub-credentials
            namespace: "{{ jenkins_namespace }}"
          type: kubernetes.io/basic-auth
          stringData:
            username: "{{ dockerhub_username }}"
            password: "{{ dockerhub_token }}"

    # â–¸ 2. github-ci-token (para acceso a GitHub desde Jenkins)
    - name: ğŸ” Crear secreto github-ci-token (GitHub token para CI/CD)
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: github-ci-token
            namespace: "{{ jenkins_namespace }}"
          type: Opaque
          stringData:
            token: "{{ github_token }}"

    # â–¸ 3. dockerhub-config (Kaniko â†’ /kaniko/.docker/config.json)
    - name: ğŸ” Crear secreto dockerhub-config (auth.json para Kaniko)
      vars:
        docker_auth_b64: "{{ (dockerhub_username + ':' + dockerhub_token) | b64encode }}"
        docker_cfg_json: |
          {
            "auths": {
              "https://index.docker.io/v1/": {
                "auth": "{{ docker_auth_b64 }}"
              }
            }
          }
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: dockerhub-config
            namespace: "{{ jenkins_namespace }}"
          type: Opaque
          stringData:
            config.json: "{{ docker_cfg_json }}"