---
# playbooks/04_create_secrets.yml
# 🔐 Secretos necesarios para Jenkins + Kaniko en PRODUCCIÓN
- hosts: localhost
  gather_facts: false
  vars_files:
    - ../vars/main.yml            # ruta a dockerhub_username / dockerhub_token / github_token …
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
    PATH: "/usr/local/bin:/usr/bin:/bin"

  tasks:
    ####################################################################
    # 0.  Cargar .env (si existe) para inyectar variables al runtime
    ####################################################################
    - name: 📥 Cargar .env manualmente (si existe)
      shell: |
        if [ -f "{{ playbook_dir }}/../.env" ]; then
          set -a && . "{{ playbook_dir }}/../.env" && set +a
        fi
      changed_when: false
      failed_when: false

    ####################################################################
    # 0.1 Validación de variables imprescindibles
    ####################################################################
    - name: ✅ Validar variables críticas
      assert:
        that:
          - dockerhub_username is defined
          - dockerhub_token     is defined
          - github_token        is defined
        fail_msg:  "❌ Faltan variables críticas para los Secrets."
        success_msg: "✅ Variables críticas presentes."

    ####################################################################
    # 1. dockerhub-credentials (→ se monta vía envFrom)
    ####################################################################
    - name: 🔐 Crear/Actualizar dockerhub-credentials
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: dockerhub-credentials
            namespace: "{{ jenkins_namespace }}"
          type: kubernetes.io/basic-auth       # requiere username / password
          stringData:
            username: "{{ dockerhub_username }}"
            password: "{{ dockerhub_token }}"

    ####################################################################
    # 2. github-ci-token  (→ se monta vía envFrom)
    ####################################################################
    - name: 🔐 Crear/Actualizar github-ci-token
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: github-ci-token
            namespace: "{{ jenkins_namespace }}"
          type: Opaque
          stringData:
            GITHUB_TOKEN: "{{ github_token }}"

    ####################################################################
    # 3. dockerhub-config  (→ Kaniko leerá /kaniko/.docker/config.json)
    ####################################################################
    - name: 🔐 Crear/Actualizar dockerhub-config (Kaniko)
      vars:
        docker_auth_b64: "{{ (dockerhub_username ~ ':' ~ dockerhub_token) | b64encode }}"
        docker_cfg: >-
          {
            "auths": {
              "https://index.docker.io/v1/": {
                "auth": "{{ docker_auth_b64 }}"
              }
            }
          }
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: dockerhub-config
            namespace: "{{ jenkins_namespace }}"
          type: Opaque
          stringData:
            config.json: "{{ docker_cfg | to_json }}"