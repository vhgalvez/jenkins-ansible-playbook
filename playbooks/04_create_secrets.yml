---
# playbooks/04_create_secrets.yml
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ” Secretos necesarios para Jenkins + Kaniko en PRODUCCIÃ“N
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- hosts: localhost
  gather_facts: false
  vars_files:
    - ../vars/main.yml        # dockerhub_username, dockerhub_token, github_tokenâ€¦
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
    PATH: "/usr/local/bin:/usr/bin:/bin"

  tasks:
    # â–¸ 1. Credenciales DockerHub (username/password) â†’ plugins de Jenkins
    - name: ğŸ” Crear secreto dockerhub-credentials (para pluginsâ€¯Jenkins)
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: dockerhub-credentials
            namespace: "{{ jenkins_namespace }}"
          type: kubernetes.io/basic-auth      # username / password
          stringData:
            username: "{{ dockerhub_username }}"
            password: "{{ dockerhub_token }}"

    # â–¸ 2. GitHub Token (PAT) â†’ usado por pipelines GitOps o CI
    - name: ğŸ” Crear secreto github-ci-token (para GitHubâ€¯CI/CD)
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: github-ci-token
            namespace: "{{ jenkins_namespace }}"
          type: Opaque
          stringData:
            token: "{{ github_token }}"

    # â–¸ 3. Config JSON de DockerHub para Kaniko â†’ /kaniko/.docker/config.json
    - name: ğŸ” Crear secreto dockerhub-config (auth.json paraâ€¯Kaniko)
      vars:
        docker_auth_b64: "{{ (dockerhub_username + ':' + dockerhub_token) | b64encode }}"
        docker_cfg_json: |
          {
            "auths": {
              "https://index.docker.io/v1/": {
                "auth": "{{ docker_auth_b64 }}"
              }
            }
          }
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: dockerhub-config
            namespace: "{{ jenkins_namespace }}"
          type: Opaque                     # Kaniko leerÃ¡ /kaniko/.docker/config.json
          stringData:
            config.json: "{{ docker_cfg_json }}"