# playbooks/create_secrets.yml
# ─────────────────────────────────────────────────────────────────────────────
# 🔐 Secretos necesarios para Jenkins + Kaniko en entorno de PRODUCCIÓN
# Este playbook debe ejecutarse con permisos para crear secretos en el namespace
# definido por la variable `jenkins_namespace`.
# ─────────────────────────────────────────────────────────────────────────────

# ▸ 1. Credenciales DockerHub (username/password) → plugin Jenkins
- name: 🔐 Crear secreto dockerhub-credentials (para plugins Jenkins)
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: dockerhub-credentials
        namespace: "{{ jenkins_namespace }}"
      type: Opaque
      stringData:
        username: "{{ dockerhub_username }}"
        password: "{{ dockerhub_token }}"

# ▸ 2. GitHub Token (PAT) → usado por pipelines GitOps o CI
- name: 🔐 Crear secreto github-ci-token (para GitHub CI/CD)
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: github-ci-token
        namespace: "{{ jenkins_namespace }}"
      type: Opaque
      stringData:
        token: "{{ github_token }}"

# ▸ 3. dockerhub-config (JSON auth para Kaniko) → se monta en /kaniko/.docker/
- name: 🔐 Crear secreto dockerhub-config (auth.json para Kaniko)
  vars:
    docker_auth_b64: "{{ (dockerhub_username + ':' + dockerhub_token) | b64encode }}"
    docker_cfg_json: |
      {
        "auths": {
          "https://index.docker.io/v1/": {
            "auth": "{{ docker_auth_b64 }}"
          }
        }
      }
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: dockerhub-config
        namespace: "{{ jenkins_namespace }}"
      type: Opaque
      stringData:
        config.json: "{{ docker_cfg_json | to_json }}"
