# playbooks/create_secrets.yml
# ---------------------------------------------------------------------------
# Crea todos los secretos que Jenkins/kaniko necesitan en PRODUCCIÃ“N.
# Ejecutar con un usuario/SA que tenga permisos para crear secrets en el
# namespace definido por "jenkins_namespace".
# ---------------------------------------------------------------------------
- name: ğŸ” Crear secreto DockerHub (credenciales plugin)
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: dockerhub-credentials
        namespace: "{{ jenkins_namespace }}"
      type: Opaque
      stringData:
        username: "{{ dockerhub_username }}"
        password: "{{ dockerhub_token }}"

- name: ğŸ” Crear secreto GitHub CI Token (string)
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: github-ci-token
        namespace: "{{ jenkins_namespace }}"
      type: Opaque
      stringData:
        token: "{{ github_token }}"

- name: ğŸ” Crear secreto dockerhub-config (JSON para kaniko)
  vars:
    docker_auth_b64: "{{ (dockerhub_username + ':' + dockerhub_token) | b64encode }}"
    docker_cfg_json: |
      {
        "auths": {
          "https://index.docker.io/v1/": {
            "auth": "{{ docker_auth_b64 }}"
          }
        }
      }
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: dockerhub-config
        namespace: "{{ jenkins_namespace }}"
      type: Opaque
      stringData:
        config.json: "{{ docker_cfg_json | to_json }}"
