# playbooks\02_render_and_apply_jenkins_ingress.yml 
---
- name: ğŸš€ Renderizar y aplicar IngressRoute y Middleware para Jenkins
  hosts: localhost
  gather_facts: false

  vars_files:
    - ../vars/main.yml

  vars:
    templates_dir: "../templates/jenkins"
    output_dir: "{{ playbook_dir }}/files"
    ingress_template: "jenkins-dashboard-ingressroute.yaml.j2"
    middleware_template: "jenkins-dashboard-middleware.yaml.j2"
    rendered_ingress: "{{ output_dir }}/jenkins-dashboard-ingressroute.yaml"
    rendered_middleware: "{{ output_dir }}/jenkins-dashboard-middleware.yaml"

  tasks:
    - name: ğŸ“ Crear carpeta de salida si no existe
      file:
        path: "{{ output_dir }}"
        state: directory
        mode: '0755'

    - name: ğŸ§© Renderizar plantilla de Middleware para Jenkins
      template:
        src: "{{ templates_dir }}/{{ middleware_template }}"
        dest: "{{ rendered_middleware }}"

    - name: ğŸŒ Renderizar plantilla de IngressRoute para Jenkins
      template:
        src: "{{ templates_dir }}/{{ ingress_template }}"
        dest: "{{ rendered_ingress }}"

    - name: ğŸš€ Aplicar Middleware al clÃºster
      command: >
        {{ kubectl_path }} --kubeconfig {{ kubeconfig_path }}
        apply -f {{ rendered_middleware }}
      register: apply_middleware
      changed_when: "'created' in apply_middleware.stdout or 'configured' in apply_middleware.stdout"

    - name: ğŸš€ Aplicar IngressRoute al clÃºster
      command: >
        {{ kubectl_path }} --kubeconfig {{ kubeconfig_path }}
        apply -f {{ rendered_ingress }}
      register: apply_ingress
      changed_when: "'created' in apply_ingress.stdout or 'configured' in apply_ingress.stdout"

    - name: âœ… Mostrar resultado final
      debug:
        msg:
          - "âœ… Middleware aplicado: {{ rendered_middleware }}"
          - "âœ… IngressRoute aplicado: {{ rendered_ingress }}"
